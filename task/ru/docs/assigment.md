# Сервис антифрода

Ваша задача — сделать сервер с REST API, который находит подозрительные транзакции по настраиваемым правилам (DSL).

> **Важно!** Ознакомьтесь с [OpenAPI-спецификацией](../openapi.yml) — это главный источник информации о требованиях к
> API.

---

## С чего начать (коротко)

1. [getting-started.md](./getting-started.md) — план старта по шагам.
2. [openapi.yml](../openapi.yml) — точные эндпоинты, поля и ошибки.
3. [dsl.md](./dsl.md) — как устроен мини-язык правил (уровни поддержки).
4. Термины: [glossary.md](./glossary.md), вопросы: [faq.md](./faq.md).

## Минимальный путь к первым баллам (для новичков)

Этот маршрут специально не требует сразу писать парсер DSL.

1. `GET /api/v1/ping` (2 балла).
2. `POST /auth/register` + `POST /auth/login` (10 баллов).
3. `GET /users/me` (часть баллов из раздела «Пользователи»).
4. `POST /fraud-rules` (хранение правил как строк) (часть баллов из раздела «Правила»).
5. DSL на самом простом уровне (Tier 0):
    - `POST /fraud-rules/validate` возвращает `isValid=false` для любого выражения.
    - `POST /transactions` создает транзакцию и возвращает полный `ruleResults` с `matched=false` для каждого правила.

Дальше добавляйте DSL по уровням поддержки, начиная с уровня 1 (Tier 1) (см. [dsl.md](./dsl.md)).

## 6 правил, которые автопроверка проверяет строго

Если нарушить один пункт, вы теряете баллы за связанные тесты.

1. **Считайте все активные правила.** Активные = `enabled=true`. `ruleResults` должен быть полным и идти в одном и том
   же порядке (сортировка: `priority`).
2. **DSL вычисляется без побочных эффектов.** Вычисление правила не должно менять пользователей/правила/настройки.
   Единственный допустимый побочный эффект проверки транзакции — сохранение самой транзакции и ее `ruleResults` (и
   производных метрик, если реализованы).
3. **Воспроизводимость (в тех же условиях).** При одинаковых правилах, одинаковом входе и одинаковом состоянии БД сервис
   обязан возвращать тот же результат (см. раздел «Воспроизводимость»).
4. **Изоляция батча.** Если реализован `POST /transactions/batch`, ошибка в одном элементе не влияет на другие элементы
   и не откатывает уже успешно созданные транзакции.
5. **Если одно правило не получается посчитать, сервис все равно живет.** Если правило нельзя вычислить (
   неподдерживаемый уровень, слишком сложное выражение, внутренняя ошибка вычисления), это не должно приводить к 5xx:
   правило считается `matched=false`, сервис продолжает обработку.
6. **DSL — язык, а не «хитрая валидация».** Логические противоречия/ тавтологии (например,
   `amount > 10 000 AND amount < 5 000`) допустимы: выражение валидируется, а при применении дает `matched=false`.

## Что нужно сделать

Вы разрабатываете систему антифрода для финтех-компании. Система должна:

1. **Регистрировать и авторизовывать пользователей** — с JWT-токенами.
2. **Хранить правила антифрода** — на простом языке, например `amount > 10000`.
3. **Проверять транзакции** — применять все правила и решать, пропустить или заблокировать.
4. **Сохранять результаты** — какие правила сработали, какие нет.

> **Важно!** Все данные должны сохраняться в базе данных. При перезапуске сервиса данные должны оставаться доступными.

---

## Воспроизводимость (в тех же условиях)

При одинаковых

- правилах (их содержимом и состоянии `enabled/priority`),
- входных данных запроса,
- состоянии базы данных,

сервис обязан возвращать **тот же** результат.

Для автопроверки допускается сравнение JSON «по смыслу»: игнорируются только поля, заведомо зависящие от
времени/генерации (`id`, `createdAt`, `updatedAt`, `traceId`, `timestamp` в ошибках и т. п.). Бизнес-поля (`status`,
`isFraud`, `ruleResults[].matched`, порядок `ruleResults`) обязаны совпадать.

## Технические требования

### Окружение

- **PostgreSQL 16** — для хранения данных.
- **Redis 7** — опционально, для кэширования.
- **Docker** — приложение запускается в контейнере.

> **Важно!** Docker-образ должен содержать утилиту `curl`. Автопроверка использует её для health-check контейнера. Без `curl` тесты не смогут запуститься. В шаблонах проекта `curl` уже установлен — если меняете базовый образ или Dockerfile, убедитесь, что `curl` присутствует в итоговом образе.

### Переменные окружения

| Переменная       | Описание                                            |
|------------------|-----------------------------------------------------|
| `ADMIN_EMAIL`    | Email администратора                                |
| `ADMIN_FULLNAME` | Полное имя администратора                           |
| `ADMIN_PASSWORD` | Пароль администратора                               | 
| `RANDOM_SECRET`  | Последовательность символов для генерации JWT ключа |
| `DB_HOST`        | Хост PostgreSQL                                     |
| `DB_PORT`        | Порт PostgreSQL                                     |
| `DB_NAME`        | Имя базы данных                                     |
| `DB_USER`        | Логин PostgreSQL                                    |
| `DB_PASSWORD`    | Пароль PostgreSQL                                   |
| `REDIS_HOST`     | Хост Redis                                          |
| `REDIS_PORT`     | Порт Redis                                          |

### JWT-токены

- Алгоритм: **HS256**.
- Время жизни: **1 час**.
- В токене: `sub` (userId), `role` (USER/ADMIN), `iat`, `exp`.
- Передается в заголовке: `Authorization: Bearer <token>`.

---

## Баллы и задания

**Всего: 100 баллов**

### Основная функциональность (90 баллов)

#### 1. Health Check — 2 балла

`GET /api/v1/ping`

Проверка, что сервер запущен и отвечает.

**Что должен делать:**

- Вернуть статус `200 OK`.
- Работать без авторизации.

**Пример ответа:**

```json
{
  "status": "ok"
}
```

> Без работающего ping автопроверка не начнется.

---

#### 2. Регистрация — 5 баллов

`POST /api/v1/auth/register`

Создает нового пользователя и возвращает токен для доступа к API.

**Что должен делать:**

- Принять данные пользователя (email, пароль, имя).
- Проверить, что email еще не занят.
- Захешировать пароль (храните пароль только в виде хеша).
- Создать пользователя с ролью `USER`.
- Вернуть JWT-токен и данные пользователя.

**Валидация полей:**

- `email` — обязательный, уникальный, максимум 254 символа.
- `password` — обязательный, 8-72 символа, минимум 1 буква и 1 цифра.
- `fullName` — обязательный, 2-200 символов.
- `age` — опциональный, диапазон 18-120.
- `region` — опциональный, максимум 32 символа.
- `gender` — опциональный, одно из: `MALE`, `FEMALE`.
- `maritalStatus` — опциональный, одно из: `SINGLE`, `MARRIED`, `DIVORCED`, `WIDOWED`.

**Пример запроса:**

```json
{
  "email": "ivan@example.com",
  "password": "SecurePass123",
  "fullName": "Иван Иванов",
  "age": 20,
  "region": "RU-MOW",
  "gender": "MALE",
  "maritalStatus": "SINGLE"
}
```

**Пример ответа (201 Created):**

```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "expiresIn": 3600,
  "user": {
    "id": "[UUID16]",
    "email": "ivan@example.com",
    "fullName": "Иван Иванов",
    "age": 20,
    "region": "RU-MOW",
    "gender": "MALE",
    "maritalStatus": "SINGLE",
    "role": "USER",
    "isActive": true,
    "createdAt": "2025-01-15T10:00:00Z",
    "updatedAt": "2025-01-15T10:00:00Z"
  }
}
```

**Коды ответов:**

- `201` — пользователь создан.
- `400` — невалидный JSON.
- `409` — email уже занят.
- `422` — ошибка валидации (например, слабый пароль).

**Начальный администратор:**

При запуске приложения должен автоматически создаваться пользователь с ролью `ADMIN`, если его ещё нет в базе данных. Данные берутся из переменных окружения:

| Переменная       | Описание                  |
|------------------|---------------------------|
| `ADMIN_EMAIL`    | Email администратора      |
| `ADMIN_FULLNAME` | Полное имя администратора |
| `ADMIN_PASSWORD` | Пароль администратора     |

Остальные поля профиля администратора (`age`, `region`, `gender`, `maritalStatus`) могут заполняться на усмотрение участника.

> **Важно!** Без начального администратора большинство тестов не пройдёт — они требуют токен с ролью `ADMIN` для работы с правилами, пользователями и статистикой.

---

#### 3. Авторизация — 5 баллов

`POST /api/v1/auth/login`

Проверяет логин/пароль и выдает токен.

**Что должен делать:**

- Найти пользователя по email.
- Проверить пароль (сравнить хеши).
- Проверить, что пользователь активен.
- Вернуть JWT-токен.

**Валидация полей:**

- `email` — обязательный, максимум 254 символа.
- `password` — обязательный, 8-72 символа.

**Пример запроса:**

```json
{
  "email": "ivan@example.com",
  "password": "SecurePass123"
}
```

**Пример ответа (200 OK):**

```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "expiresIn": 3600,
  "user": {
    "id": "[UUID17]",
    "email": "ivan@example.com",
    "fullName": "Иван Иванов",
    "age": 20,
    "region": "RU-MOW",
    "gender": "MALE",
    "maritalStatus": "SINGLE",
    "role": "USER",
    "isActive": true,
    "createdAt": "2025-01-15T10:00:00Z",
    "updatedAt": "2025-01-15T10:00:00Z"
  }
}
```

**Коды ответов:**

- `200` — успешный вход.
- `400` — невалидный JSON.
- `401` — неверный email или пароль.
- `422` — невалидный формат email/пароля.
- `423` — пользователь деактивирован (заблокирован).

---

#### 4. Управление пользователями — 28 баллов

Набор эндпоинтов для работы с профилями пользователей.

**Эндпоинты:**

| Метод    | URL                  | Описание                                   | Кто может                         |
|----------|----------------------|--------------------------------------------|-----------------------------------|
| `GET`    | `/api/v1/users/me`   | Получить свой профиль                      | Все                               |
| `PUT`    | `/api/v1/users/me`   | Обновить свой профиль                      | Все                               |
| `GET`    | `/api/v1/users/{id}` | Получить профиль по ID                     | USER — только свой, ADMIN — любой |
| `PUT`    | `/api/v1/users/{id}` | Обновить профиль по ID                     | USER — только свой, ADMIN — любой |
| `GET`    | `/api/v1/users`      | Список всех пользователей                  | Только ADMIN                      |
| `POST`   | `/api/v1/users`      | Создать пользователя (без токена в ответе) | Только ADMIN                      |
| `DELETE` | `/api/v1/users/{id}` | Деактивировать пользователя                | Только ADMIN                      |

**Как начисляются баллы (можно делать частями):**

| Часть | Что проверяется                                                     | Баллы |
|------:|---------------------------------------------------------------------|------:|
|     A | `GET /users/me` (по JWT)                                            |     4 |
|     B | `PUT /users/me` (full update + missing vs null)                     |     6 |
|     C | Доступы USER/ADMIN для `GET /users/{id}`                            |     4 |
|     D | `PUT /users/{id}` (full update + ограничения USER по role/isActive) |     6 |
|     E | `GET /users` (ADMIN + пагинация)                                    |     4 |
|     F | `POST /users` (ADMIN create)                                        |     2 |
|     G | `DELETE /users/{id}` (soft-delete + идемпотентность)                |     2 |

**Важные правила:**

1. **USER может работать только со своим профилем.** Если USER пытается получить или изменить чужой профиль, вернуть
   `403 Forbidden`.

2. **PUT — полное обновление.** Необходимо передать все поля. Чтобы очистить опциональное поле, передайте `null`.
   Пример:

```json
{
  "fullName": "Новое Имя",
  "age": 25,
  "region": null,
  "gender": "MALE",
  "maritalStatus": null
}
```

3. **USER не может менять свою роль и статус.** Если USER попытается передать `role` или `isActive`, вернуть `403`.

4. **DELETE не удаляет пользователя, а деактивирует.** Устанавливает `isActive = false`. Деактивированный пользователь
   не может войти в систему.

5. **POST /users (только ADMIN)** требует обязательного поля `role` (`USER` или `ADMIN`). Остальные поля и их валидация
   аналогичны регистрации.

**Обязательные поля при обновлении (PUT /users):**

Тело запроса обязано содержать **все ключи** из таблицы ниже:

- Если ключ отсутствует (поле **не передано**), это ошибка валидации и сервис обязан вернуть `422`.
- если ключ присутствует, но значение `null`, это явная команда «Очистить поле» (допустимо только для nullable-полей).

| Поле            | Тип                | Ограничения                                |
|-----------------|--------------------|--------------------------------------------|
| `fullName`      | string             | 2—200 символов, не может быть `null`       |
| `age`           | integer или `null` | 18—120                                     |
| `region`        | string или `null`  | максимум 32 символа                        |
| `gender`        | string или `null`  | `MALE`, `FEMALE`                           |
| `maritalStatus` | string или `null`  | `SINGLE`, `MARRIED`, `DIVORCED`, `WIDOWED` |

> **Важно!** ADMIN при обновлении может также передавать `role` и `isActive`.

**Пример: получить свой профиль**

`GET /api/v1/users/me`

Ответ (200 OK):

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "email": "ivan@example.com",
  "fullName": "Иван Иванов",
  "age": 20,
  "region": "RU-MOW",
  "gender": "MALE",
  "maritalStatus": "SINGLE",
  "role": "USER",
  "isActive": true,
  "createdAt": "2025-01-15T10:00:00Z",
  "updatedAt": "2025-01-15T10:00:00Z"
}
```

**Пример: список пользователей (только ADMIN)**

`GET /api/v1/users?page=0&size=20`

> **Параметры пагинации:** `page` — номер страницы (min 0, по умолчанию 0), `size` — размер страницы (min 1, max 100, по умолчанию 20). При невалидных значениях — `422`.

> **Сортировка:** по `createdAt` (ASC)

Ответ (200 OK):

```json
{
  "items": [
    {
      "id": "...",
      "email": "ivan@example.com",
      "fullName": "Иван Иванов",
      ...
    },
    {
      "id": "...",
      "email": "anna@example.com",
      "fullName": "Анна Петрова",
      ...
    }
  ],
  "total": 42,
  "page": 0,
  "size": 20
}
```

---

#### 5. Правила антифрода — 10 баллов

Правила — это условия на простом языке (DSL), которые проверяют транзакции на мошенничество.

**Эндпоинты:**

| Метод    | URL                        | Описание                             |
|----------|----------------------------|--------------------------------------|
| `POST`   | `/api/v1/fraud-rules`      | Создать правило                      |
| `GET`    | `/api/v1/fraud-rules`      | Список всех правил                   |
| `GET`    | `/api/v1/fraud-rules/{id}` | Получить правило по ID               |
| `PUT`    | `/api/v1/fraud-rules/{id}` | Обновить правило (полное обновление) |
| `DELETE` | `/api/v1/fraud-rules/{id}` | Деактивировать правило               |

> Все эндпоинты доступны только для ADMIN.

**Как начисляются баллы (можно делать частями):**

| Часть | Что проверяется                                 | Баллы |
|------:|-------------------------------------------------|------:|
|     A | CRUD правил + сохранение в БД                   |     6 |
|     B | `enabled=false` выключает правило (soft-delete) |     2 |
|     C | Конфликты (например, имя занято => `409`)       |     2 |

**Поля правила:**

- `name` — название (3—120 символов), например «Большие суммы».
- `description` — описание (опционально, до 500 символов).
- `dslExpression` — условие на языке DSL (3—2 000 символов), например `amount > 10 000`.
- `enabled` — активно ли правило (по умолчанию `true`).
- `priority` — приоритет, число от 1 и выше (меньше = важнее, по умолчанию 100).

> **Важно!** При обновлении правила (`PUT /fraud-rules/{id}`) необходимо передать **все обязательные поля** (`name`,
`dslExpression`, `enabled`, `priority`). Это полное обновление, а не частичное.

> **Важно про частичную реализацию DSL!** Правило может использовать возможности уровня поддержки, который вы еще не
> сделали. Такое правило можно хранить и возвращать через API, а при применении оно обязано вести себя устойчиво:
`matched=false`, сервис не падает. Детали: [dsl.md](./dsl.md).

**Пример: создать правило**

`POST /api/v1/fraud-rules`

> Примечание: на вход можно передать любой DSL (если он неверный, то в транзакциях должно выдавать `matched=False`)

Запрос:

```json
{
  "name": "Большие суммы",
  "description": "Блокировать транзакции свыше 100 000",
  "dslExpression": "amount > 100000",
  "enabled": true,
  "priority": 10
}
```

Ответ (201 Created):

```json
{
  "id": "660e8400-e29b-41d4-a716-446655440001",
  "name": "Большие суммы",
  "description": "Блокировать транзакции свыше 100 000",
  "dslExpression": "amount > 100000",
  "enabled": true,
  "priority": 10,
  "createdAt": "2025-01-15T10:00:00Z",
  "updatedAt": "2025-01-15T10:00:00Z"
}
```

**DELETE не удаляет правило, а деактивирует** — устанавливает `enabled = false`.

**Коды ответов:**

- `201` — правило создано.
- `409` — правило с таким именем уже существует.
- `422` — ошибка валидации полей (например, name/priority).

---

#### 6. Валидация DSL — 10 баллов

`POST /api/v1/fraud-rules/validate`

Проверяет выражение DSL на корректность **без сохранения** в базу. Полезно для предпросмотра перед созданием правила. *
*Доступно только для ADMIN.**

**Как начисляются баллы (частичная реализация — нормально):**

| Часть | Что проверяется                                                                                   | Баллы |
|------:|---------------------------------------------------------------------------------------------------|------:|
|     A | Endpoint существует, всегда `200`, формат ответа корректен, `errors[].code` машиночитаемый        |     2 |
|     B | Уровень поддержки 1 (Tier 1): парсинг `amount`, нормализация, `DSL_PARSE_ERROR` с `position/near` |     4 |
|     C | Уровень поддержки 2 (Tier 2): строки/поля/`DSL_INVALID_OPERATOR`                                  |     2 |
|     D | Уровень поддержки 3 (Tier 3): `AND/OR` и приоритет `AND > OR`                                     |     1 |
|     E | Уровень поддержки 4 (Tier 4): `NOT` и скобки                                                      |     1 |

Уровень поддержки 0 (Tier 0, разрешенный старт): допускается всегда возвращать `isValid=false` и получить баллы части A.

**Что должен делать:**

- Распарсить выражение.
- Вернуть `isValid: true` если все ок.
- Вернуть `isValid: false` и список ошибок, если есть проблемы.
- Ошибки в `errors[].code` обязаны быть машиночитаемыми и не требовать парсинга текста `message`:
    - `DSL_PARSE_ERROR` — синтаксическая ошибка (для этого кода `position` и `near` обязаны быть заполнены.)
    - `DSL_INVALID_FIELD` — неизвестное поле DSL.
    - `DSL_INVALID_OPERATOR` — оператор неприменим к типу значения.

**Пример: корректное выражение**

Запрос:

```json
{
  "dslExpression": "amount > 10000 AND currency = 'RUB'"
}
```

> **Валидация:** `dslExpression` от 3 до 2000 символов

Ответ (200 OK):

```json
{
  "isValid": true,
  "normalizedExpression": "amount > 10000 AND currency = 'RUB'",
  "errors": []
}
```

**Пример: некорректное выражение**

Запрос:

```json
{
  "dslExpression": "amount > AND currency"
}
```

Ответ (200 OK):

```json
{
  "isValid": false,
  "normalizedExpression": null,
  "errors": [
    {
      "code": "DSL_PARSE_ERROR",
      "message": "Ожидалось число после '>'",
      "position": 9,
      "near": "> AND"
    }
  ]
}
```

> Обратите внимание: даже при ошибке возвращается `200 OK`, потому что сам запрос обработан успешно. Ошибка — в
> проверяемом выражении, а не в запросе.

> `POST /fraud-rules/validate` показывает, может ли выражение быть вычислено в вашей текущей реализации (уровень
> поддержки). Это подсказка: правила могут храниться в БД, а при применении сервис обязан работать устойчиво (
> см. [dsl.md](./dsl.md)).

---

#### 7. Транзакции — 20 баллов

Главная функциональность сервиса — проверка транзакций на мошенничество.

**Эндпоинты:**

| Метод  | URL                         | Описание                                                  |
|--------|-----------------------------|-----------------------------------------------------------|
| `POST` | `/api/v1/transactions`      | Создать транзакцию и проверить на фрод                    |
| `GET`  | `/api/v1/transactions`      | Список транзакций (в порядке убывания по времени операции)|
| `GET`  | `/api/v1/transactions/{id}` | Получить транзакцию с результатами проверки               |

**Фильтры для GET /transactions:**

- `userId` — фильтр по пользователю (только ADMIN).
- `status` — фильтр по статусу (`APPROVED`, `DECLINED`).
- `isFraud` — фильтр по флагу фрода (`true`/`false`).
- `from`, `to` — фильтр по периоду (RFC3339).
- `page`, `size` — пагинация.

> USER видит только свои транзакции. ADMIN видит все и может фильтровать по userId.

**Как работает проверка:**

1. Пользователь отправляет данные транзакции (сумму, валюту, магазин и т. д.).
2. Система загружает все активные правила (`enabled = true`).
3. Правила сортируются по `priority` (меньше = первым), затем по `id`.
4. Каждое правило применяется к транзакции (нельзя останавливаться раньше: результаты должны быть посчитаны для **всех**
   активных правил).
5. Если хотя бы одно правило сработало, транзакция `DECLINED` (отклонена).
6. Если ни одно не сработало, транзакция `APPROVED` (одобрена).
7. Транзакция сохраняется вместе с результатами **всех** правил.

**Устойчивость к ошибкам правил:**

- Если отдельное правило не удается вычислить (например, неподдерживаемый уровень / слишком сложное выражение), оно
  считается `matched=false`, а обработка транзакции продолжается.

**Поля транзакции:**

| Поле                   | Обязательное     | Описание                                                          |
|------------------------|------------------|-------------------------------------------------------------------|
| `userId`               | Только для ADMIN | UUID пользователя. Для USER оно должно быть идентично JWT (`sub`) |
| `amount`               | Да               | Сумма (0.01 - 999999999.99)                                       |
| `currency`             | Да               | Код валюты ISO 4217 (3 заглавные буквы, например `RUB`, `USD`)    |
| `timestamp`            | Да               | Время операции RFC3339 (не более 5 минут в будущее)               |
| `merchantId`           | Нет              | Идентификатор магазина (до 64 символов)                           |
| `merchantCategoryCode` | Нет              | MCC-код (4 цифры, например `5411`)                                |
| `ipAddress`            | Нет              | IP-адрес клиента (до 64 символов)                                 |
| `deviceId`             | Нет              | Идентификатор устройства (до 128 символов)                        |
| `channel`              | Нет              | Канал: `WEB`, `MOBILE`, `POS`, `OTHER`                            |
| `location`             | Нет              | Объект с геолокацией                                              |
| `metadata`             | Нет              | Произвольные дополнительные данные                                |

**Поля location:**

- `country` — ISO 3166-1 alpha-2 код страны (ровно 2 заглавные буквы).
- `city` — название города (до 128 символов).
- `latitude` — широта (-90 до 90), обязательно вместе с longitude.
- `longitude` — долгота (-180 до 180), обязательно вместе с latitude.

**Пример: создать транзакцию**

`POST /api/v1/transactions`

Запрос:

```json
{
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "amount": 15000,
  "currency": "RUB",
  "merchantId": "shop-123",
  "merchantCategoryCode": "5411",
  "timestamp": "2025-01-15T10:30:00Z",
  "ipAddress": "192.168.1.1",
  "deviceId": "device-abc",
  "channel": "WEB",
  "location": {
    "country": "RU",
    "city": "Moscow",
    "latitude": 55.7558,
    "longitude": 37.6173
  },
  "metadata": {
    "cartSize": 3
  }
}
```

Ответ (201 Created) — транзакция отклонена:

```json
{
  "transaction": {
    "id": "770e8400-e29b-41d4-a716-446655440002",
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "amount": 15000,
    "currency": "RUB",
    "status": "DECLINED",
    "merchantId": "shop-123",
    "merchantCategoryCode": "5411",
    "timestamp": "2025-01-15T10:30:00Z",
    "ipAddress": "192.168.1.1",
    "deviceId": "device-abc",
    "channel": "WEB",
    "location": {
      "country": "RU",
      "city": "Moscow",
      "latitude": 55.7558,
      "longitude": 37.6173
    },
    "isFraud": true,
    "metadata": {
      "cartSize": 3
    },
    "createdAt": "2025-01-15T10:30:01Z"
  },
  "ruleResults": [
    {
      "ruleId": "660e8400-e29b-41d4-a716-446655440001",
      "ruleName": "Большие суммы",
      "priority": 10,
      "enabled": true,
      "matched": true,
      "description": "amount > 10000, правило сработало"
    },
    {
      "ruleId": "660e8400-e29b-41d4-a716-446655440002",
      "ruleName": "Проверка валюты",
      "priority": 20,
      "enabled": true,
      "matched": false,
      "description": "currency = 'USD', правило не сработало"
    }
  ]
}
```

**Важно:**

- Даже отклоненные транзакции возвращают `201 Created` (это бизнес-решение, не ошибка).
- В ответе возвращаются результаты всех правил, не только сработавших.
- USER может создавать транзакции только для себя: фактический `userId` должен быть равен `userId` из JWT (`sub`)
- ADMIN может создавать транзакции для любого пользователя: `userId` обязателен в теле запроса.
- `ruleResults[].description` обязателен и должен быть человекочитаемым объяснением (автопроверка проверяет наличие, а
  не текст).

**Коды ответов для POST:**

- `201` — транзакция создана (APPROVED или DECLINED).
- `400` — невалидный JSON.
- `403` — попытка создать транзакцию для деактивированного пользователя (`isActive=false`).
- `404` — пользователь с указанным userId не найден.
- `422` — ошибка валидации полей.

**Коды ответов для GET /transactions/{id}:**

- `200` — транзакция с результатами правил.
- `403` — USER пытается получить чужую транзакцию.
- `404` — транзакция не найдена.

**Как начисляются баллы (можно начать без парсинга DSL):**

| Часть | Что проверяется                                                                                                                          | Баллы |
|------:|------------------------------------------------------------------------------------------------------------------------------------------|------:|
|     A | Транзакция создается и сохраняется в БД, `GET /transactions/{id}` возвращает сохраненное (без пересчета)                                 |     8 |
|     B | Применяются **все** активные правила: `ruleResults` полный / в правильном порядке, `description` непустой, нельзя останавливаться раньше |     8 |
|     C | Корректное вычисление DSL для уровней поддержки 1–4 (Tier 1–4) (matched/status/isFraud)                                                  |     2 |
|     D | Контекст пользователя (уровень 5 / Tier 5): `user.age`/`user.region` влияет на matched                                                   |     2 |

Уровень поддержки 0 (Tier 0, разрешенный старт): допускается не парсить DSL и считать каждое правило `matched=false`.
Тогда можно получить баллы частей A и B (при корректной структуре данных и воспроизводимости).

---

#### 8. Батч-транзакции — 10 баллов

`POST /api/v1/transactions/batch`

Создание нескольких транзакций одним запросом. Полезно для массовой загрузки данных.

**Как начисляются баллы (можно делать частями):**

| Часть | Что проверяется                                                 | Баллы |
|------:|-----------------------------------------------------------------|------:|
|     A | Формат ответа (index, decision/error), обработка массива 1..500 |     4 |
|     B | `207` при частичном успехе (поэлементные ошибки)                |     4 |
|     C | Изоляция: ошибки не откатывают успешные элементы                |     2 |

**Что должен делать:**

- Принять массив транзакций (от 1 до 500 штук).
- Обработать каждую транзакцию независимо.
- Вернуть результат по каждой транзакции с индексом (0-based).

**Правило согласованного состояния для батча:**

- Ошибка в одном элементе не влияет на остальные.
- Успешно созданные элементы не откатываются, даже если в батче есть ошибки (в ответе `207`).

Примечание: для роли USER поле `userId` в элементах батча можно не передавать. Если передать, оно будет проигнорировано,
фактический `userId` берется из JWT (`sub`).

**Пример запроса:**

```json
{
  "items": [
    {
      "userId": "550e8400-e29b-41d4-a716-446655440000",
      "amount": 1000,
      "currency": "RUB",
      "timestamp": "2025-01-15T10:30:00Z"
    },
    {
      "userId": "550e8400-e29b-41d4-a716-446655440000",
      "amount": 50000,
      "currency": "RUB",
      "timestamp": "2025-01-15T10:31:00Z"
    }
  ]
}
```

**Пример ответа (201 — все успешно):**

```json
{
  "items": [
    {
      "index": 0,
      "decision": {
        "transaction": {
          "id": "...",
          "status": "APPROVED",
          ...
        },
        "ruleResults": [
          ...
        ]
      }
    },
    {
      "index": 1,
      "decision": {
        "transaction": {
          "id": "...",
          "status": "DECLINED",
          ...
        },
        "ruleResults": [
          ...
        ]
      }
    }
  ]
}
```

**Коды ответов:**

- `201` — все транзакции обработаны успешно.
- `207` — частичный успех (некоторые с ошибками).

При `207` некоторые элементы будут содержать `error` вместо `decision`:

```json
{
  "index": 2,
  "error": {
    "code": "VALIDATION_FAILED",
    "message": "amount must be > 0"
  }
}
```

---

### Статистика (12 баллов)

Эти эндпоинты — бонусные. Реализуйте их, если справились с основной частью.

---

#### 9. Обзор метрик — 3 балла

`GET /api/v1/stats/overview`

Возвращает сводную статистику по транзакциям за указанный период. Доступно только для ADMIN.

**Параметры запроса:**

- `from` — начало периода (RFC3339, включительно).
- `to` — конец периода (RFC3339, **исключительно**).

> **Ограничения:** `from` < `to`, максимальный период — 90 дней. По умолчанию: последние 30 дней.

**Что должен возвращать:**

- `volume` — общее количество транзакций.
- `gmv` — общая сумма всех транзакций (Gross Merchandise Value).
- `approvalRate` — доля одобренных транзакций (от 0 до 1).
- `declineRate` — доля отклоненных транзакций (от 0 до 1).
- `topRiskMerchants` — топ-10 магазинов с наибольшим процентом отклонений.

**Пример запроса:**

`GET /api/v1/stats/overview?from=2025-01-01T00:00:00Z&to=2025-01-31T23:59:59Z`

**Пример ответа (200 OK):**

```json
{
  "from": "2025-01-01T00:00:00Z",
  "to": "2025-01-31T23:59:59Z",
  "volume": 15420,
  "gmv": 45678900.50,
  "approvalRate": 0.87,
  "declineRate": 0.13,
  "topRiskMerchants": [
    {
      "merchantId": "shop-999",
      "merchantCategoryCode": "7995",
      "txCount": 150,
      "gmv": 4500000.00,
      "declineRate": 0.45
    },
    {
      "merchantId": "shop-777",
      "merchantCategoryCode": "5411",
      "txCount": 89,
      "gmv": 1200000.00,
      "declineRate": 0.38
    }
  ]
}
```

---

#### 10. Временной ряд — 3 балла

`GET /api/v1/stats/transactions/timeseries`

Возвращает метрики транзакций, сгруппированные по времени. Полезно для построения графиков. Доступно только для ADMIN.

**Параметры запроса:**

- `from`, `to` — период (RFC3339, `from` включительно, `to` исключительно).
- `groupBy` — группировка: `hour`, `day` или `week` (по умолчанию `day`).
- `timezone` — часовой пояс (по умолчанию `UTC`).
- `channel` — опциональный фильтр по каналу (`WEB`, `MOBILE`, `POS`, `OTHER`).

> **Ограничения по groupBy:** `hour` — макс. 7 дней, `day` — макс. 90 дней, `week` — макс. 90 дней.

**Что должен возвращать:**

Массив точек, где каждая точка содержит:

- `bucketStart` — начало временного интервала.
- `txCount` — количество транзакций.
- `gmv` — сумма транзакций.
- `approvalRate`, `declineRate` — доли по статусам.

**Пример запроса:**

`GET /api/v1/stats/transactions/timeseries?from=2025-01-01T00:00:00Z&to=2025-01-07T23:59:59Z&groupBy=day`

**Пример ответа (200 OK):**

```json
{
  "points": [
    {
      "bucketStart": "2025-01-01T00:00:00Z",
      "txCount": 2150,
      "gmv": 6543210.00,
      "approvalRate": 0.89,
      "declineRate": 0.11
    },
    {
      "bucketStart": "2025-01-02T00:00:00Z",
      "txCount": 2340,
      "gmv": 7123456.00,
      "approvalRate": 0.85,
      "declineRate": 0.15
    }
  ]
}
```

---

#### 11. Статистика правил — 2 балла

`GET /api/v1/stats/rules/matches`

Показывает, сколько раз сработало каждое правило антифрода. Доступно только для ADMIN.

**Параметры запроса:**

- `from`, `to` — период (RFC3339, `from` включительно, `to` исключительно).
- `top` — сколько правил вернуть (от 1 до 100, по умолчанию 20).

> **Ограничения:** `from` < `to`, максимальный период — 90 дней. По умолчанию: последние 30 дней.

**Что должен возвращать для каждого правила:**

- `ruleId`, `ruleName` — идентификатор и название.
- `matches` — сколько раз правило сработало.
- `uniqueUsers` — сколько уникальных пользователей затронуто.
- `uniqueMerchants` — сколько уникальных мерчантов затронуто (опционально).
- `shareOfDeclines` — какая доля от всех отклонений приходится на это правило.

**Пример ответа (200 OK):**

```json
{
  "items": [
    {
      "ruleId": "550e8400-e29b-41d4-a716-446655440001",
      "ruleName": "Большие суммы",
      "matches": 1250,
      "uniqueUsers": 890,
      "uniqueMerchants": 45,
      "shareOfDeclines": 0.62
    },
    {
      "ruleId": "550e8400-e29b-41d4-a716-446655440002",
      "ruleName": "Молодые пользователи",
      "matches": 430,
      "uniqueUsers": 215,
      "uniqueMerchants": 32,
      "shareOfDeclines": 0.21
    }
  ]
}
```

---

#### 12. Риск-метрики по мерчантам — 2 балла

`GET /api/v1/stats/merchants/risk`

Возвращает риск-метрики по мерчантам. Доступно только для ADMIN.

**Параметры запроса:**

- `from`, `to` — период (RFC3339, `from` включительно, `to` исключительно).
- `merchantCategoryCode` — опциональный фильтр по MCC коду (4 цифры).
- `top` — сколько мерчантов вернуть (от 1 до 200, по умолчанию 50).

> **Ограничения:** `from` < `to`, максимальный период — 90 дней. По умолчанию: последние 30 дней.

**Что должен возвращать для каждого мерчанта:**

- `merchantId` — идентификатор мерчанта.
- `merchantCategoryCode` — MCC-код (опционально).
- `txCount` — количество транзакций.
- `gmv` — сумма транзакций.
- `declineRate` — доля отклоненных транзакций.

**Пример ответа (200 OK):**

```json
{
  "items": [
    {
      "merchantId": "shop-999",
      "merchantCategoryCode": "7995",
      "txCount": 150,
      "gmv": 4500000.00,
      "declineRate": 0.45
    },
    {
      "merchantId": "shop-777",
      "merchantCategoryCode": "5411",
      "txCount": 89,
      "gmv": 1200000.00,
      "declineRate": 0.38
    }
  ]
}
```

---

#### 13. Риск-профиль пользователя — 2 балла

`GET /api/v1/stats/users/{id}/risk-profile`

Возвращает метрики риска для конкретного пользователя. USER может смотреть только свой профиль, ADMIN — любой.

**Что должен возвращать:**

- `txCount_24h` — количество транзакций за последние 24 часа.
- `gmv_24h` — сумму транзакций за 24 часа.
- `distinctDevices_24h` — со скольких разных устройств были транзакции.
- `distinctIps_24h` — со скольких разных IP-адресов.
- `distinctCities_24h` — из скольких разных городов.
- `declineRate_30d` — процент отклонений за 30 дней.
- `lastSeenAt` — время последней активности (может быть `null`, если активности не было).

**Пример ответа (200 OK):**

```json
{
  "userId": "550e8400-e29b-41d4-a716-446655440099",
  "txCount_24h": 5,
  "gmv_24h": 12500.00,
  "distinctDevices_24h": 2,
  "distinctIps_24h": 3,
  "distinctCities_24h": 1,
  "declineRate_30d": 0.08,
  "lastSeenAt": "2025-01-15T14:30:00Z"
}
```

> Этот эндпоинт полезен для анализа подозрительной активности: если пользователь делает покупки из разных городов
> одновременно, это может быть признаком мошенничества.

---

## DSL

Полные правила DSL вынесены в [dsl.md](./dsl.md) (уровни поддержки, грамматика, проверка, «не падать из‑за
одного правила», воспроизводимость).

---

## HTTP-коды ответов

| Код | Когда                                       |
|-----|---------------------------------------------|
| 200 | Успешный GET или PUT                        |
| 201 | Успешный POST (включая DECLINED транзакции) |
| 204 | Успешный DELETE                             |
| 400 | Невалидный JSON                             |
| 401 | Нет токена или токен невалидный             |
| 403 | Нет прав доступа                            |
| 404 | Ресурс не найден                            |
| 409 | Email или имя правила уже занято            |
| 422 | Ошибка валидации полей                      |
| 423 | Пользователь деактивирован                  |

### Коды ошибок

| Код                        | HTTP | Когда                                          |
|----------------------------|------|------------------------------------------------|
| `BAD_REQUEST`              | 400  | Невалидный JSON, неподдерживаемый Content-Type |
| `VALIDATION_FAILED`        | 422  | Поля не прошли валидацию                       |
| `UNAUTHORIZED`             | 401  | Токен отсутствует/невалиден/истёк; неверный email или пароль в /auth/login |
| `FORBIDDEN`                | 403  | Недостаточно прав или доступ к чужому ресурсу  |
| `NOT_FOUND`                | 404  | Ресурс не найден                               |
| `EMAIL_ALREADY_EXISTS`     | 409  | Email уже занят                                |
| `USER_INACTIVE`            | 423  | Пользователь деактивирован                     |
| `RULE_NAME_ALREADY_EXISTS` | 409  | Правило с таким именем уже существует          |
| `INTERNAL_SERVER_ERROR`    | 500  | Внутренняя ошибка сервера                      |

Коды ошибок в методах с DSL правилами:

| Код                    | Когда                      |
|------------------------|----------------------------|
| `DSL_PARSE_ERROR`      | Синтаксическая ошибка      |
| `DSL_INVALID_FIELD`    | Неизвестное поле DSL       |
| `DSL_INVALID_OPERATOR` | Оператор неприменим к типу |

**Формат ошибки:**

```json
{
  "code": "ERROR_CODE",
  "message": "Описание ошибки",
  "traceId": "uuid-для-трейсинга",
  "timestamp": "2025-01-15T10:00:00Z",
  "path": "/api/v1/endpoint"
}
```

> Поля `message` и `fieldErrors[].issue` — человекочитаемые. Автопроверка не сравнивает их содержимое, проверяется только наличие.

**Формат ошибки валидации (422):**

```json
{
  "code": "VALIDATION_FAILED",
  "message": "Некоторые поля не прошли валидацию",
  "traceId": "uuid-для-трейсинга",
  "timestamp": "2025-01-15T10:00:00Z",
  "path": "/api/v1/endpoint",
  "fieldErrors": [
    {
      "field": "amount",
      "issue": "must be >= 0.01",
      "rejectedValue": -10
    }
  ]
}
```

---

## Как запускать и где ответы на вопросы

- Локальный запуск: [local-run.md](./local-run.md)
- Частые ошибки и FAQ: [faq.md](./faq.md)

**Какие поля в объекте Transaction могут отсутствовать?**
Поля `merchantId`, `merchantCategoryCode`, `ipAddress`, `deviceId`, `channel`, `location`, `metadata` опциональны.
Обязательны: `id`, `userId`, `amount`, `currency`, `status`, `timestamp`, `isFraud`, `createdAt`.

